# apiVersion: v1
# kind: ServiceAccount
# metadata:
#   # TODO: find a way to refer to the environment name (if terraform creates the operator service account using the environment name)
#   name: external-secrets 
#   namespace: {{ .Release.Namespace }}
#   annotations:
#     iam.gke.io/gcp-service-account: external-secrets-operator@{{ .Values.global.gcp.projectId }}.iam.gserviceaccount.com
# ---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: gcp-secret-store
  namespace: {{ .Release.Namespace }}
spec:
  provider:
    gcpsm:
      projectId: {{ .Values.global.gcp.projectId }}
      auth:
        workloadIdentity: 
          clusterLocation: {{ .Values.global.gcp.gke.clusterLocation }}
          clusterName: {{ .Values.global.gcp.gke.clusterName }}
          clusterProjectID: {{ .Values.global.gcp.projectId }}
          serviceAccountRef:
            name: external-secrets 

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: example
spec:
  refreshInterval: 1h           # rate SecretManager pulls GCPSM
  secretStoreRef:
    kind: SecretStore
    name: gcp-secret-store
  target:
    name: secret-to-be-created  # name of the k8s Secret to be created
    creationPolicy: Owner
  data:
  - secretKey: dev-secret-test  # name of the GCPSM secret key
    remoteRef:
      key: dev-secret-test
